#include <16F877a.h>
#device ADC=10
#use delay(crystal=20000000)
#FUSES NOWDT, NOBROWNOUT, NOLVP

#include <lcd_c.c> //Incluir librería LCD
#include <kbd4x4_b.c> //Librería teclado 4x4 puerto B
#include <getNum16.c> //Librería para leer numeros enteros de 16 bits

#USE STANDARD_IO(D)
#USE STANDARD_IO(A)

#define boton_paro PIN_E2

int8 pasosuni[4] = {
   0b0011,
   0b0110,
   0b1100,
   0b1001
};

int8 pasosbi[8] = {
   0b1000,
   0b1010,
   0b0010,
   0b0110,
   0b0100,
   0b0101,
   0b0001,
   0b1001
};
float pasoanterior=0;
int8 index = 0;
float grados;
float pasos_a_recorrer;
int16 origen;
int1 motor;

void regresar();
void regresaruni();

void paro_emergencia(){
   printf(lcd_putc,"\fPARO DE EMERG"); // Mostrar mensaje
   while(input(boton_paro) == 1){} // Esperar a que el usuario suelte el botón de paro
   printf(lcd_putc,"\fPRESIONAR TECLA"); // Mostrar mensaje
   char c = read_key(); // Esperar a que el usuario presione una tecla
   if(motor==1){
      regresar();
   }
   else{
      regresaruni();
   }
}

void PreguntarDato(){//preguntar al usuario dato a ingresar
int1 condicion;
    do{
         printf(lcd_putc,"\fIGRESA GRADOS: ");
         grados = get_num_lcd(1,2);
         condicion = (grados<=360 && grados>=0);
         if(condicion == 0)
         {
            printf(lcd_putc,"\fNOT VALID");
            delay_ms(1000);
         }
      }while(condicion == 0);
}
void PreguntarMotor(){//preguntar al usuario dato a ingresar
int1 condicion;
    do{
         printf(lcd_putc,"\fMOTOR UNI:1 BI:2");
         motor = get_num_lcd(1,2);
         condicion = (motor==1 || motor==2);
         if(condicion == 1)
         {
            printf(lcd_putc,"\fNOT VALID");
            delay_ms(1000);
         }
      }while(condicion == 1);
}

void absoluto(){
   pasos_a_recorrer=abs(pasoanterior-grados)/0.9005;
}
void absolutouni(){
   pasos_a_recorrer=abs(pasoanterior-grados)/0.176;
}

void updatePortuni(){
   output_a(pasosuni[index]);
}
void incrementIndexuni(){
   if(index == 3){
      index = 0;
   }else{
      index++;
   }
}

void decrementIndexuni(){
   if(index == 0){
      index = 3;
   }else{
      index--;
   }
}
int1 rigthuni(){
   absoluto();
   for(int16 i = 0; i < pasos_a_recorrer; i++){
         incrementIndexuni();
         updatePortuni();
         delay_ms(100);
         origen=i;
         if(input(boton_paro)){
         paro_emergencia();
         return 1; // 1 porque salió mal
      }
   }
         pasoanterior=grados;
   return 0;
}

int1 leftuni(){
   absoluto();
   for(int16 i = 0; i < pasos_a_recorrer; i++){
         decrementIndexuni();
         updatePortuni();
         delay_ms(100);
         origen=i;
         if(input(boton_paro)){
         paro_emergencia();
         return 1; // 1 porque salió mal
      }
   }
         pasoanterior=grados;
   return 0;

}

void updatePort(){
   output_d(pasosbi[index]);
}

void incrementIndex(){
   if(index == 7){
      index = 0;
   }else{
      index++;
   }
}

void decrementIndex(){
   if(index == 0){
      index = 7;
   }else{
      index--;
   }
}
int1 rigth(){
   absoluto();
   for(int16 i = 0; i < pasos_a_recorrer; i++){
         incrementIndex();
         updatePort();
         delay_ms(100);
         origen=i;
         if(input(boton_paro)){
         paro_emergencia();
         return 1; // 1 porque salió mal
      }
   }
         pasoanterior=grados;
   return 0;
}

int1 left(){
   absoluto();
   for(int16 i = 0; i < pasos_a_recorrer; i++){
         decrementIndex();
         updatePort();
         delay_ms(100);
         origen=i;
         if(input(boton_paro)){
         paro_emergencia();
         return 1; // 1 porque salió mal
      }
   }
         pasoanterior=grados;
   return 0;

}

void regresar(){
   pasos_a_recorrer=origen;
   for(int16 i = 0; i < pasos_a_recorrer+1; i++){
         decrementIndex();
         updatePort();
         delay_ms(50);
      }
}
void regresaruni(){
   pasos_a_recorrer=origen;
   for(int16 i = 0; i < pasos_a_recorrer+1; i++){
         decrementIndexuni();
         updatePortuni();
         delay_ms(50);
      }
}


void main(){
   port_b_pullups(1);
   kbd_init(); //Inicializar teclado
   lcd_init(); //Inicializar pantalla
   
   updatePort();
   delay_ms(50);
   
   while(TRUE){
      
      PreguntarMotor();
      switch (motor){
         case 1:
            PreguntarDato();
            if(grados>pasoanterior){
               rigth();
            }
            else{
               left();
            }
         break;
         case 2:
            PreguntarDato();
            if(grados>pasoanterior){
               rigth();
            }
            else{
               left();
            }
         break;
      } 
   }
}
